generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TECHNICIAN
}

enum TechnicianStatus {
  ACTIVE
  LOCKED
  INACTIVE
}

enum CallStatus {
  PENDING
  ROUTED
  ANSWERED
  MISSED
  COMPLETED
  CANCELLED
}

enum ServiceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  LOCK
  UNLOCK
  QUOTA_RESET
  CALL_ROUTED
  SERVICE_COMPLETED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  role          Role      @default(TECHNICIAN)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  technician    Technician?
  auditLogs     AuditLog[]
  
  @@index([email])
  @@index([role])
}

model Technician {
  id                  String           @id @default(uuid())
  userId              String           @unique
  phone               String?
  status              TechnicianStatus @default(ACTIVE)
  weeklyQuota         Int              @default(25)
  currentWeekCompleted Int             @default(0)
  lastQuotaReset      DateTime         @default(now())
  lockedAt            DateTime?
  lockedReason        String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  user                User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules           Schedule[]
  calls               Call[]
  serviceRecords      ServiceRecord[]
  
  @@index([status])
  @@index([userId])
}

model Schedule {
  id            String    @id @default(uuid())
  technicianId  String
  dayOfWeek     Int       // 0 = Sunday, 6 = Saturday
  startTime     String    // HH:mm format
  endTime       String    // HH:mm format
  isAvailable   Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  technician    Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)
  
  @@unique([technicianId, dayOfWeek])
  @@index([technicianId])
  @@index([dayOfWeek])
}

model Call {
  id                  String     @id @default(uuid())
  ringcentralCallId   String     @unique
  technicianId        String?
  callerNumber        String
  callerName          String?
  status              CallStatus @default(PENDING)
  duration            Int?       // seconds
  recordingUrl        String?
  routedAt            DateTime?
  answeredAt          DateTime?
  endedAt             DateTime?
  metadata            Json?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  
  technician          Technician? @relation(fields: [technicianId], references: [id])
  serviceRecord       ServiceRecord?
  
  @@index([technicianId])
  @@index([status])
  @@index([createdAt])
  @@index([ringcentralCallId])
}

model ServiceRecord {
  id              String        @id @default(uuid())
  technicianId    String
  callId          String?       @unique
  customerName    String
  customerPhone   String
  customerAddress String?
  applianceType   String
  issueDescription String
  diagnosis       String?
  resolution      String?
  partsUsed       String?
  laborHours      Float?
  status          ServiceStatus @default(SCHEDULED)
  scheduledDate   DateTime?
  completedAt     DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  technician      Technician    @relation(fields: [technicianId], references: [id])
  call            Call?         @relation(fields: [callId], references: [id])
  
  @@index([technicianId])
  @@index([status])
  @@index([createdAt])
  @@index([completedAt])
}

model AuditLog {
  id          String      @id @default(uuid())
  userId      String?
  action      AuditAction
  entityType  String
  entityId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())
  
  user        User?       @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
}
