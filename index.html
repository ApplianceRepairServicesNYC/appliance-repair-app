<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lumina Leads Services</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--bg-primary:#0f0f13;--bg-secondary:#1a1a23;--bg-tertiary:#252533;--bg-hover:#2d2d3d;
--text-primary:#f0f0f5;--text-secondary:#a0a0b0;--text-muted:#6a6a7a;
--accent:#6366f1;--accent-hover:#818cf8;
--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--purple:#a855f7;
--border:#2a2a3a;--shadow:0 4px 24px rgba(0,0,0,0.4);
--radius:8px;--radius-lg:12px;
}
html{font-size:14px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;line-height:1.5}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit}
input,select,textarea{font-family:inherit;font-size:inherit;color:var(--text-primary);background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);padding:0.5rem 0.75rem;outline:none;transition:border-color 0.2s}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
select{cursor:pointer}
textarea{resize:vertical;min-height:60px}

.login-overlay{position:fixed;inset:0;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;z-index:1000}
.login-box{background:var(--bg-secondary);padding:3rem;border-radius:var(--radius-lg);box-shadow:var(--shadow);text-align:center;max-width:360px;width:90%}
.login-box h1{font-size:1.5rem;margin-bottom:0.5rem;font-weight:600;background:linear-gradient(135deg,#6366f1,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.login-box p{color:var(--text-secondary);margin-bottom:2rem;font-size:0.9rem}
.login-box input{width:100%;text-align:center;font-size:1.5rem;letter-spacing:0.5rem;padding:1rem;margin-bottom:1rem}
.login-box button{width:100%;padding:0.875rem;background:var(--accent);color:#fff;border-radius:var(--radius);font-weight:600;transition:background 0.2s}
.login-box button:hover{background:var(--accent-hover)}
.login-error{color:var(--danger);font-size:0.85rem;margin-top:0.5rem}
.hidden{display:none!important}

.app{display:flex;flex-direction:column;height:100vh}
header{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-shrink:0}
.logo{font-size:1.25rem;font-weight:700;display:flex;align-items:center;gap:0.5rem;background:linear-gradient(135deg,#6366f1,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.header-actions{display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap}
.btn{padding:0.5rem 1rem;border-radius:var(--radius);font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:0.5rem;font-size:0.85rem}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent-hover)}
.btn-secondary{background:var(--bg-tertiary);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--bg-hover)}
.btn-success{background:var(--success);color:#fff}
.btn-success:hover{background:#16a34a}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{background:#dc2626}
.btn-sm{padding:0.375rem 0.75rem;font-size:0.8rem}

.toolbar{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:0.75rem 1.5rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;flex-shrink:0}
.tabs{display:flex;gap:0.25rem;background:var(--bg-tertiary);padding:0.25rem;border-radius:var(--radius)}
.tab{padding:0.5rem 1rem;border-radius:calc(var(--radius) - 2px);font-size:0.9rem;color:var(--text-secondary);transition:all 0.2s}
.tab:hover{color:var(--text-primary)}
.tab.active{background:var(--accent);color:#fff}
.search-box{position:relative;flex:1;max-width:300px}
.search-box input{width:100%;padding-left:2.25rem}
.search-box::before{content:"‚åï";position:absolute;left:0.75rem;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:1rem}
.filter-group{display:flex;align-items:center;gap:0.5rem}
.filter-group label{color:var(--text-secondary);font-size:0.85rem}

main{flex:1;overflow:auto;padding:1.5rem}
.table-container{background:var(--bg-secondary);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow)}
table{width:100%;border-collapse:collapse;min-width:1400px}
thead{background:var(--bg-tertiary);position:sticky;top:0;z-index:10}
th{padding:1rem;text-align:left;font-weight:600;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-secondary);border-bottom:1px solid var(--border)}
td{padding:0.875rem 1rem;border-bottom:1px solid var(--border);vertical-align:top}
tr:hover td{background:var(--bg-hover)}
.cell-name{font-weight:500}
.cell-phone a{color:var(--info);text-decoration:none}
.cell-phone a:hover{text-decoration:underline}
.cell-notes{max-width:200px}
.notes-preview{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;color:var(--text-secondary);font-size:0.9rem;cursor:pointer}
.notes-preview:hover{color:var(--text-primary)}

.status-btns{display:flex;flex-wrap:wrap;gap:0.25rem}
.status-btn{padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.03em;opacity:0.4;transition:all 0.15s;border:1px solid transparent}
.status-btn:hover{opacity:0.7}
.status-btn.active{opacity:1;box-shadow:0 0 0 1px currentColor}
.status-booked{background:rgba(34,197,94,0.15);color:var(--success);border-color:var(--success)}
.status-cancelled{background:rgba(239,68,68,0.15);color:var(--danger);border-color:var(--danger)}
.status-notbooked{background:rgba(107,114,128,0.15);color:#9ca3af;border-color:#6b7280}
.status-followup{background:rgba(245,158,11,0.15);color:var(--warning);border-color:var(--warning)}
.status-quotes{background:rgba(168,85,247,0.15);color:var(--purple);border-color:var(--purple)}

.badge{display:inline-block;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;font-weight:600}
.badge-cash{background:rgba(34,197,94,0.15);color:var(--success)}
.badge-check{background:rgba(59,130,246,0.15);color:var(--info)}
.badge-cod{background:rgba(245,158,11,0.15);color:var(--warning)}

.checkbox-cell{text-align:center}
.checkbox{width:18px;height:18px;cursor:pointer;accent-color:var(--accent)}

.actions-cell{display:flex;gap:0.5rem}
.icon-btn{width:32px;height:32px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;transition:background 0.2s;font-size:1rem}
.icon-btn:hover{background:var(--bg-tertiary)}
.icon-btn.danger:hover{background:rgba(239,68,68,0.2);color:var(--danger)}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100;padding:1rem}
.modal{background:var(--bg-secondary);border-radius:var(--radius-lg);box-shadow:var(--shadow);max-width:600px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.modal.modal-lg{max-width:900px}
.modal-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-header h2{font-size:1.125rem;font-weight:600}
.modal-close{font-size:1.5rem;color:var(--text-muted);transition:color 0.2s}
.modal-close:hover{color:var(--text-primary)}
.modal-body{padding:1.5rem;overflow-y:auto;flex:1}
.modal-footer{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:0.75rem}
.modal-footer-right{display:flex;gap:0.75rem}

.form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
.form-group{display:flex;flex-direction:column;gap:0.375rem}
.form-group.full{grid-column:1/-1}
.form-group label{font-size:0.85rem;color:var(--text-secondary);font-weight:500}

.history-list{display:flex;flex-direction:column;gap:0.75rem}
.history-item{background:var(--bg-tertiary);padding:0.875rem;border-radius:var(--radius);border-left:3px solid var(--accent)}
.history-meta{font-size:0.75rem;color:var(--text-muted);margin-bottom:0.375rem}
.history-change{font-size:0.9rem}
.history-change .field{color:var(--accent);font-weight:500}
.history-change .old{color:var(--danger);text-decoration:line-through;margin:0 0.25rem}
.history-change .new{color:var(--success);margin:0 0.25rem}
.no-history{text-align:center;color:var(--text-muted);padding:2rem}

.empty-state{text-align:center;padding:4rem 2rem;color:var(--text-secondary)}
.empty-state h3{font-size:1.25rem;margin-bottom:0.5rem;color:var(--text-primary)}

.bulk-container{display:flex;flex-direction:column;gap:1rem}
.bulk-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:0.75rem;align-items:end;padding:1rem;background:var(--bg-tertiary);border-radius:var(--radius);position:relative}
.bulk-row .form-group{margin:0}
.bulk-row .form-group label{font-size:0.75rem}
.bulk-row-num{position:absolute;left:-0.5rem;top:-0.5rem;width:1.5rem;height:1.5rem;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700}
.bulk-remove{color:var(--danger);font-size:1.25rem;padding:0.5rem;border-radius:var(--radius);transition:background 0.2s}
.bulk-remove:hover{background:rgba(239,68,68,0.2)}
.bulk-add-row{padding:0.875rem;border:2px dashed var(--border);border-radius:var(--radius);color:var(--text-secondary);font-weight:500;transition:all 0.2s;text-align:center}
.bulk-add-row:hover{border-color:var(--accent);color:var(--accent);background:rgba(99,102,241,0.05)}
.bulk-info{display:flex;align-items:center;gap:0.5rem;color:var(--text-secondary);font-size:0.85rem}
.bulk-info strong{color:var(--accent)}

.sync-notice{background:var(--bg-tertiary);border:1px solid var(--warning);border-radius:var(--radius);padding:1rem;margin-bottom:1rem}
.sync-notice h4{color:var(--warning);font-size:0.9rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem}
.sync-notice p{font-size:0.85rem;color:var(--text-secondary);margin-bottom:0.75rem}
.sync-actions{display:flex;gap:0.5rem;flex-wrap:wrap}

.file-input{display:none}
.dropdown{position:relative;display:inline-block}
.dropdown-content{display:none;position:absolute;right:0;top:100%;margin-top:0.25rem;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius);min-width:180px;box-shadow:var(--shadow);z-index:50;overflow:hidden}
.dropdown:hover .dropdown-content{display:block}
.dropdown-item{display:block;width:100%;padding:0.75rem 1rem;text-align:left;font-size:0.85rem;color:var(--text-primary);transition:background 0.15s}
.dropdown-item:hover{background:var(--bg-hover)}
.dropdown-divider{height:1px;background:var(--border);margin:0.25rem 0}

@media(max-width:768px){
.form-grid{grid-template-columns:1fr}
.toolbar{flex-direction:column;align-items:stretch}
.search-box{max-width:none}
.tabs{overflow-x:auto;flex-wrap:nowrap}
header{flex-direction:column;align-items:stretch}
.header-actions{justify-content:center}
.bulk-row{grid-template-columns:1fr 1fr;gap:0.5rem}
.logo{justify-content:center}
}
</style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
<div class="login-box">
<h1>‚ú¶ Lumina Leads Services</h1>
<p>Enter PIN to access the system</p>
<input type="password" id="pinInput" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autofocus>
<button onclick="attemptLogin()">Unlock</button>
<div id="loginError" class="login-error hidden">Incorrect PIN</div>
</div>
</div>

<div id="app" class="app hidden">
<header>
<div class="logo">‚ú¶ Lumina Leads Services</div>
<div class="header-actions">
<button class="btn btn-primary" onclick="openAddModal()">+ New</button>
<button class="btn btn-success" onclick="openBulkModal()">‚ö° Bulk</button>
<div class="dropdown">
<button class="btn btn-secondary">‚òÅÔ∏è Sync ‚ñæ</button>
<div class="dropdown-content">
<button class="dropdown-item" onclick="exportData()">‚Üì Export Data</button>
<button class="dropdown-item" onclick="document.getElementById('importFile').click()">‚Üë Import Data</button>
<div class="dropdown-divider"></div>
<button class="dropdown-item" onclick="copyDataToClipboard()">üìã Copy to Clipboard</button>
<button class="dropdown-item" onclick="pasteDataFromClipboard()">üì• Paste from Clipboard</button>
</div>
</div>
<input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
<button class="btn btn-secondary" onclick="logout()">Logout</button>
</div>
</header>

<div class="toolbar">
<div class="tabs" id="periodTabs"></div>
<div class="search-box">
<input type="text" id="searchInput" placeholder="Search name or phone..." oninput="applyFilters()">
</div>
<div class="filter-group">
<label>Status:</label>
<select id="statusFilter" onchange="applyFilters()">
<option value="">All</option>
<option value="booked">Booked</option>
<option value="cancelled">Cancelled</option>
<option value="notbooked">Not Booked</option>
<option value="followup">Follow-Up</option>
<option value="quotes">Seeking Quotes</option>
</select>
</div>
</div>

<main>
<div class="table-container">
<table>
<thead>
<tr>
<th>Customer</th>
<th>Phone</th>
<th>Location</th>
<th>Appliance</th>
<th>Pay Rate</th>
<th>Status</th>
<th>Notes</th>
<th>Call Date</th>
<th>Scheduled</th>
<th>1st</th>
<th>2nd</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
<div id="emptyState" class="empty-state hidden">
<h3>No entries found</h3>
<p>Add a new entry or adjust your filters</p>
</div>
</main>
</div>

<div id="entryModal" class="modal-overlay hidden">
<div class="modal">
<div class="modal-header">
<h2 id="modalTitle">Add New Entry</h2>
<button class="modal-close" onclick="closeModal('entryModal')">&times;</button>
</div>
<div class="modal-body">
<div class="form-grid">
<div class="form-group">
<label>Customer Name *</label>
<input type="text" id="f_name" required>
</div>
<div class="form-group">
<label>Phone *</label>
<input type="tel" id="f_phone" required>
</div>
<div class="form-group">
<label>Location</label>
<select id="f_location">
<option value="">Select...</option>
<option>Manhattan</option>
<option>Brooklyn</option>
<option>Queens</option>
<option>Bronx</option>
<option>Staten Island</option>
<option>Nassau County</option>
<option>Suffolk County</option>
<option>Westchester</option>
<option>New Jersey</option>
</select>
</div>
<div class="form-group">
<label>Appliance Brand/Type</label>
<input type="text" id="f_appliance" placeholder="e.g., Samsung Refrigerator">
</div>
<div class="form-group">
<label>Pay Rate</label>
<select id="f_payrate">
<option value="">Select...</option>
<option value="cash">Cash</option>
<option value="check">Check</option>
<option value="cod">COD</option>
</select>
</div>
<div class="form-group">
<label>Status</label>
<select id="f_status">
<option value="notbooked">Not Booked</option>
<option value="booked">Booked</option>
<option value="cancelled">Cancelled</option>
<option value="followup">Follow-Up</option>
<option value="quotes">Seeking Quotes</option>
</select>
</div>
<div class="form-group">
<label>Call Date</label>
<input type="date" id="f_calldate">
</div>
<div class="form-group">
<label>Scheduled Date</label>
<input type="date" id="f_scheduled">
</div>
<div class="form-group full">
<label>Issue Description</label>
<textarea id="f_issue" placeholder="Describe the problem..."></textarea>
</div>
<div class="form-group full">
<label>Notes / Updates</label>
<textarea id="f_notes" placeholder="Additional notes..."></textarea>
</div>
</div>
</div>
<div class="modal-footer">
<div></div>
<div class="modal-footer-right">
<button class="btn btn-secondary" onclick="closeModal('entryModal')">Cancel</button>
<button class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
</div>
</div>
</div>
</div>

<div id="bulkModal" class="modal-overlay hidden">
<div class="modal modal-lg">
<div class="modal-header">
<h2>‚ö° Bulk Add Entries</h2>
<button class="modal-close" onclick="closeModal('bulkModal')">&times;</button>
</div>
<div class="modal-body">
<div class="bulk-container" id="bulkContainer"></div>
<button class="bulk-add-row" onclick="addBulkRow()">+ Add Another Row</button>
</div>
<div class="modal-footer">
<div class="bulk-info">
<span>Rows: <strong id="bulkCount">0</strong></span>
<span>|</span>
<span>Press <strong>Tab</strong> to move between fields</span>
</div>
<div class="modal-footer-right">
<button class="btn btn-secondary" onclick="closeModal('bulkModal')">Cancel</button>
<button class="btn btn-success" onclick="saveBulkEntries()">Save All Entries</button>
</div>
</div>
</div>
</div>

<div id="historyModal" class="modal-overlay hidden">
<div class="modal">
<div class="modal-header">
<h2>Change History</h2>
<button class="modal-close" onclick="closeModal('historyModal')">&times;</button>
</div>
<div class="modal-body">
<div id="historyList" class="history-list"></div>
</div>
<div class="modal-footer">
<div></div>
<div class="modal-footer-right">
<button class="btn btn-secondary" onclick="closeModal('historyModal')">Close</button>
</div>
</div>
</div>
</div>

<div id="notesModal" class="modal-overlay hidden">
<div class="modal">
<div class="modal-header">
<h2>Notes & Issue Details</h2>
<button class="modal-close" onclick="closeModal('notesModal')">&times;</button>
</div>
<div class="modal-body">
<div class="form-group">
<label>Issue Description</label>
<div id="notesIssue" style="background:var(--bg-tertiary);padding:1rem;border-radius:var(--radius);margin-bottom:1rem;white-space:pre-wrap"></div>
</div>
<div class="form-group">
<label>Notes / Updates</label>
<div id="notesContent" style="background:var(--bg-tertiary);padding:1rem;border-radius:var(--radius);white-space:pre-wrap"></div>
</div>
</div>
<div class="modal-footer">
<div></div>
<div class="modal-footer-right">
<button class="btn btn-secondary" onclick="closeModal('notesModal')">Close</button>
</div>
</div>
</div>
</div>

<div id="syncModal" class="modal-overlay hidden">
<div class="modal">
<div class="modal-header">
<h2>‚òÅÔ∏è Sync Data Between Devices</h2>
<button class="modal-close" onclick="closeModal('syncModal')">&times;</button>
</div>
<div class="modal-body">
<div class="sync-notice">
<h4>‚ö†Ô∏è Important: Data is stored locally</h4>
<p>This dashboard stores data in your browser's local storage. Data does NOT automatically sync between devices (desktop, mobile, different browsers).</p>
</div>
<h4 style="margin-bottom:1rem;color:var(--text-primary)">How to sync your data:</h4>
<div style="display:flex;flex-direction:column;gap:1rem">
<div style="background:var(--bg-tertiary);padding:1rem;border-radius:var(--radius)">
<strong style="color:var(--accent)">Option 1: Export/Import File</strong>
<p style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.5rem">Export your data as a JSON file on one device, then import it on another device.</p>
</div>
<div style="background:var(--bg-tertiary);padding:1rem;border-radius:var(--radius)">
<strong style="color:var(--accent)">Option 2: Copy/Paste via Clipboard</strong>
<p style="font-size:0.85rem;color:var(--text-secondary);margin-top:0.5rem">Copy data to clipboard, send it to yourself (email, notes app), then paste on the other device.</p>
</div>
</div>
</div>
<div class="modal-footer">
<div></div>
<div class="modal-footer-right">
<button class="btn btn-secondary" onclick="closeModal('syncModal')">Got it</button>
</div>
</div>
</div>
</div>

<script>
const PIN = "1234";
const STORAGE_KEY = "lumina_leads_data";
const AUTH_KEY = "lumina_leads_auth";

let data = {};
let currentPeriod = "";
let editingId = null;
let bulkRowCount = 0;

function init() {
  if (localStorage.getItem(AUTH_KEY) === "true") {
    showApp();
  }
  loadData();
  generatePeriodTabs();
  render();
}

function attemptLogin() {
  const pin = document.getElementById("pinInput").value;
  if (pin === PIN) {
    localStorage.setItem(AUTH_KEY, "true");
    showApp();
  } else {
    document.getElementById("loginError").classList.remove("hidden");
    document.getElementById("pinInput").value = "";
  }
}

function showApp() {
  document.getElementById("loginOverlay").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
}

function logout() {
  localStorage.removeItem(AUTH_KEY);
  location.reload();
}

function loadData() {
  const stored = localStorage.getItem(STORAGE_KEY);
  data = stored ? JSON.parse(stored) : {};
}

function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function generatePeriodTabs() {
  const tabs = document.getElementById("periodTabs");
  const periods = [];
  const now = new Date();
  for (let i = -2; i <= 2; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
    const key = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
    const label = d.toLocaleDateString("en-US", { month: "short", year: "numeric" });
    periods.push({ key, label });
  }
  currentPeriod = periods[2].key;
  tabs.innerHTML = periods.map(p => 
    `<button class="tab ${p.key === currentPeriod ? 'active' : ''}" onclick="switchPeriod('${p.key}')">${p.label}</button>`
  ).join("");
}

function switchPeriod(period) {
  currentPeriod = period;
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`.tab[onclick*="${period}"]`).classList.add("active");
  render();
}

function getPeriodData() {
  if (!data[currentPeriod]) data[currentPeriod] = [];
  return data[currentPeriod];
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

function applyFilters() {
  render();
}

function render() {
  const entries = getPeriodData();
  const search = document.getElementById("searchInput").value.toLowerCase();
  const statusFilter = document.getElementById("statusFilter").value;
  
  let filtered = entries.filter(e => {
    if (search && !e.name.toLowerCase().includes(search) && !e.phone.includes(search)) return false;
    if (statusFilter && e.status !== statusFilter) return false;
    return true;
  });
  
  filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  const tbody = document.getElementById("tableBody");
  const empty = document.getElementById("emptyState");
  
  if (filtered.length === 0) {
    tbody.innerHTML = "";
    empty.classList.remove("hidden");
    return;
  }
  
  empty.classList.add("hidden");
  tbody.innerHTML = filtered.map(e => renderRow(e)).join("");
}

function renderRow(e) {
  const payBadge = e.payrate ? `<span class="badge badge-${e.payrate}">${e.payrate.toUpperCase()}</span>` : '-';
  const statuses = ['booked', 'cancelled', 'notbooked', 'followup', 'quotes'];
  const statusLabels = { booked: 'Booked', cancelled: 'Cancel', notbooked: 'Not Booked', followup: 'Follow-Up', quotes: 'Quotes' };
  const statusBtns = statuses.map(s => 
    `<button class="status-btn status-${s} ${e.status === s ? 'active' : ''}" onclick="setStatus('${e.id}','${s}')">${statusLabels[s]}</button>`
  ).join("");
  
  const notesPreview = (e.notes || e.issue) ? 
    `<div class="notes-preview" onclick="showNotes('${e.id}')">${(e.notes || e.issue || '').substring(0, 60)}${(e.notes || e.issue || '').length > 60 ? '...' : ''}</div>` : '-';
  
  return `<tr>
    <td class="cell-name">${esc(e.name)}</td>
    <td class="cell-phone"><a href="tel:${e.phone}">${esc(e.phone)}</a></td>
    <td>${esc(e.location) || '-'}</td>
    <td>${esc(e.appliance) || '-'}</td>
    <td>${payBadge}</td>
    <td><div class="status-btns">${statusBtns}</div></td>
    <td class="cell-notes">${notesPreview}</td>
    <td>${e.calldate || '-'}</td>
    <td>${e.scheduled || '-'}</td>
    <td class="checkbox-cell"><input type="checkbox" class="checkbox" ${e.call1 ? 'checked' : ''} onchange="toggleCheck('${e.id}','call1',this.checked)"></td>
    <td class="checkbox-cell"><input type="checkbox" class="checkbox" ${e.call2 ? 'checked' : ''} onchange="toggleCheck('${e.id}','call2',this.checked)"></td>
    <td><div class="actions-cell">
      <button class="icon-btn" onclick="openEditModal('${e.id}')" title="Edit">‚úèÔ∏è</button>
      <button class="icon-btn" onclick="showHistory('${e.id}')" title="History">üìú</button>
      <button class="icon-btn danger" onclick="deleteEntry('${e.id}')" title="Delete">üóëÔ∏è</button>
    </div></td>
  </tr>`;
}

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function openAddModal() {
  editingId = null;
  document.getElementById("modalTitle").textContent = "Add New Entry";
  clearForm();
  document.getElementById("f_calldate").value = new Date().toISOString().split('T')[0];
  document.getElementById("entryModal").classList.remove("hidden");
}

function openEditModal(id) {
  const entry = getPeriodData().find(e => e.id === id);
  if (!entry) return;
  editingId = id;
  document.getElementById("modalTitle").textContent = "Edit Entry";
  document.getElementById("f_name").value = entry.name || "";
  document.getElementById("f_phone").value = entry.phone || "";
  document.getElementById("f_location").value = entry.location || "";
  document.getElementById("f_appliance").value = entry.appliance || "";
  document.getElementById("f_payrate").value = entry.payrate || "";
  document.getElementById("f_status").value = entry.status || "notbooked";
  document.getElementById("f_calldate").value = entry.calldate || "";
  document.getElementById("f_scheduled").value = entry.scheduled || "";
  document.getElementById("f_issue").value = entry.issue || "";
  document.getElementById("f_notes").value = entry.notes || "";
  document.getElementById("entryModal").classList.remove("hidden");
}

function clearForm() {
  ["f_name","f_phone","f_location","f_appliance","f_payrate","f_status","f_calldate","f_scheduled","f_issue","f_notes"].forEach(id => {
    const el = document.getElementById(id);
    if (el.tagName === "SELECT") el.selectedIndex = 0;
    else el.value = "";
  });
  document.getElementById("f_status").value = "notbooked";
}

function saveEntry() {
  const name = document.getElementById("f_name").value.trim();
  const phone = document.getElementById("f_phone").value.trim();
  if (!name || !phone) {
    alert("Name and Phone are required");
    return;
  }
  
  const newData = {
    name,
    phone,
    location: document.getElementById("f_location").value,
    appliance: document.getElementById("f_appliance").value.trim(),
    payrate: document.getElementById("f_payrate").value,
    status: document.getElementById("f_status").value,
    calldate: document.getElementById("f_calldate").value,
    scheduled: document.getElementById("f_scheduled").value,
    issue: document.getElementById("f_issue").value.trim(),
    notes: document.getElementById("f_notes").value.trim()
  };
  
  const entries = getPeriodData();
  
  if (editingId) {
    const idx = entries.findIndex(e => e.id === editingId);
    if (idx > -1) {
      const old = entries[idx];
      const changes = [];
      const fields = {name:'Name',phone:'Phone',location:'Location',appliance:'Appliance',payrate:'Pay Rate',status:'Status',calldate:'Call Date',scheduled:'Scheduled',issue:'Issue',notes:'Notes'};
      for (const [key, label] of Object.entries(fields)) {
        if (old[key] !== newData[key]) {
          changes.push({ field: label, old: old[key] || '(empty)', new: newData[key] || '(empty)', time: new Date().toISOString() });
        }
      }
      if (changes.length > 0) {
        if (!old.history) old.history = [];
        old.history.push(...changes);
      }
      Object.assign(old, newData);
    }
  } else {
    newData.id = generateId();
    newData.createdAt = new Date().toISOString();
    newData.call1 = false;
    newData.call2 = false;
    newData.history = [];
    entries.push(newData);
  }
  
  saveData();
  closeModal("entryModal");
  render();
}

function openBulkModal() {
  bulkRowCount = 0;
  document.getElementById("bulkContainer").innerHTML = "";
  addBulkRow();
  addBulkRow();
  addBulkRow();
  document.getElementById("bulkModal").classList.remove("hidden");
  setTimeout(() => {
    const firstInput = document.querySelector("#bulkContainer input");
    if (firstInput) firstInput.focus();
  }, 100);
}

function addBulkRow() {
  bulkRowCount++;
  const container = document.getElementById("bulkContainer");
  const row = document.createElement("div");
  row.className = "bulk-row";
  row.id = `bulk-row-${bulkRowCount}`;
  row.innerHTML = `
    <span class="bulk-row-num">${bulkRowCount}</span>
    <div class="form-group">
      <label>Name *</label>
      <input type="text" class="bulk-name" placeholder="Customer name">
    </div>
    <div class="form-group">
      <label>Phone *</label>
      <input type="tel" class="bulk-phone" placeholder="Phone number">
    </div>
    <div class="form-group">
      <label>Location</label>
      <select class="bulk-location">
        <option value="">Select...</option>
        <option>Manhattan</option>
        <option>Brooklyn</option>
        <option>Queens</option>
        <option>Bronx</option>
        <option>Staten Island</option>
        <option>Nassau County</option>
        <option>Suffolk County</option>
        <option>Westchester</option>
        <option>New Jersey</option>
      </select>
    </div>
    <div class="form-group">
      <label>Appliance</label>
      <input type="text" class="bulk-appliance" placeholder="Brand/Type">
    </div>
    <button class="bulk-remove" onclick="removeBulkRow(${bulkRowCount})" title="Remove row">&times;</button>
  `;
  container.appendChild(row);
  updateBulkCount();
}

function removeBulkRow(num) {
  const row = document.getElementById(`bulk-row-${num}`);
  if (row) {
    row.remove();
    updateBulkCount();
  }
}

function updateBulkCount() {
  const count = document.querySelectorAll(".bulk-row").length;
  document.getElementById("bulkCount").textContent = count;
}

function saveBulkEntries() {
  const rows = document.querySelectorAll(".bulk-row");
  const entries = getPeriodData();
  const today = new Date().toISOString().split('T')[0];
  let added = 0;
  
  rows.forEach(row => {
    const name = row.querySelector(".bulk-name").value.trim();
    const phone = row.querySelector(".bulk-phone").value.trim();
    const location = row.querySelector(".bulk-location").value;
    const appliance = row.querySelector(".bulk-appliance").value.trim();
    
    if (name && phone) {
      entries.push({
        id: generateId(),
        name,
        phone,
        location,
        appliance,
        payrate: "",
        status: "notbooked",
        calldate: today,
        scheduled: "",
        issue: "",
        notes: "",
        call1: false,
        call2: false,
        history: [],
        createdAt: new Date().toISOString()
      });
      added++;
    }
  });
  
  if (added === 0) {
    alert("Please fill in at least one entry with Name and Phone");
    return;
  }
  
  saveData();
  closeModal("bulkModal");
  render();
  alert(`Successfully added ${added} entries!`);
}

function setStatus(id, status) {
  const entries = getPeriodData();
  const entry = entries.find(e => e.id === id);
  if (entry && entry.status !== status) {
    if (!entry.history) entry.history = [];
    entry.history.push({ field: 'Status', old: entry.status || 'none', new: status, time: new Date().toISOString() });
    entry.status = status;
    saveData();
    render();
  }
}

function toggleCheck(id, field, checked) {
  const entries = getPeriodData();
  const entry = entries.find(e => e.id === id);
  if (entry) {
    if (!entry.history) entry.history = [];
    const label = field === 'call1' ? '1st Call' : '2nd Call';
    entry.history.push({ field: label, old: entry[field] ? 'Checked' : 'Unchecked', new: checked ? 'Checked' : 'Unchecked', time: new Date().toISOString() });
    entry[field] = checked;
    saveData();
  }
}

function deleteEntry(id) {
  if (!confirm("Delete this entry?")) return;
  const entries = getPeriodData();
  const idx = entries.findIndex(e => e.id === id);
  if (idx > -1) {
    entries.splice(idx, 1);
    saveData();
    render();
  }
}

function showHistory(id) {
  const entry = getPeriodData().find(e => e.id === id);
  if (!entry) return;
  const list = document.getElementById("historyList");
  if (!entry.history || entry.history.length === 0) {
    list.innerHTML = '<div class="no-history">No changes recorded yet</div>';
  } else {
    const sorted = [...entry.history].sort((a, b) => new Date(b.time) - new Date(a.time));
    list.innerHTML = sorted.map(h => `
      <div class="history-item">
        <div class="history-meta">${new Date(h.time).toLocaleString()}</div>
        <div class="history-change">
          <span class="field">${h.field}</span>: 
          <span class="old">${esc(h.old)}</span> ‚Üí 
          <span class="new">${esc(h.new)}</span>
        </div>
      </div>
    `).join("");
  }
  document.getElementById("historyModal").classList.remove("hidden");
}

function showNotes(id) {
  const entry = getPeriodData().find(e => e.id === id);
  if (!entry) return;
  document.getElementById("notesIssue").textContent = entry.issue || '(No issue description)';
  document.getElementById("notesContent").textContent = entry.notes || '(No notes)';
  document.getElementById("notesModal").classList.remove("hidden");
}

function closeModal(id) {
  document.getElementById(id).classList.add("hidden");
}

function exportData() {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `lumina_leads_backup_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (confirm(`Import data? This will MERGE with your existing data. Continue?`)) {
        for (const [period, entries] of Object.entries(imported)) {
          if (!data[period]) data[period] = [];
          const existingIds = new Set(data[period].map(e => e.id));
          for (const entry of entries) {
            if (!existingIds.has(entry.id)) {
              data[period].push(entry);
            }
          }
        }
        saveData();
        render();
        alert("Data imported successfully!");
      }
    } catch (err) {
      alert("Error importing file. Make sure it's a valid JSON backup.");
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

async function copyDataToClipboard() {
  try {
    await navigator.clipboard.writeText(JSON.stringify(data));
    alert("Data copied to clipboard! You can now paste it on another device.");
  } catch (err) {
    const textArea = document.createElement("textarea");
    textArea.value = JSON.stringify(data);
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert("Data copied! You can now paste it on another device.");
  }
}

async function pasteDataFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    const imported = JSON.parse(text);
    if (confirm(`Paste data from clipboard? This will MERGE with your existing data. Continue?`)) {
      for (const [period, entries] of Object.entries(imported)) {
        if (!data[period]) data[period] = [];
        const existingIds = new Set(data[period].map(e => e.id));
        for (const entry of entries) {
          if (!existingIds.has(entry.id)) {
            data[period].push(entry);
          }
        }
      }
      saveData();
      render();
      alert("Data imported from clipboard!");
    }
  } catch (err) {
    const text = prompt("Paste your data here:");
    if (text) {
      try {
        const imported = JSON.parse(text);
        if (confirm(`Import pasted data? This will MERGE with your existing data.`)) {
          for (const [period, entries] of Object.entries(imported)) {
            if (!data[period]) data[period] = [];
            const existingIds = new Set(data[period].map(e => e.id));
            for (const entry of entries) {
              if (!existingIds.has(entry.id)) {
                data[period].push(entry);
              }
            }
          }
          saveData();
          render();
          alert("Data imported!");
        }
      } catch (e) {
        alert("Invalid data format. Make sure you copied the correct data.");
      }
    }
  }
}

document.getElementById("pinInput").addEventListener("keypress", e => {
  if (e.key === "Enter") attemptLogin();
});

document.querySelectorAll(".modal-overlay").forEach(m => {
  m.addEventListener("click", e => {
    if (e.target === m) closeModal(m.id);
  });
});

init();
</script>
</body>
</html>
